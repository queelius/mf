# Site Contract

This document specifies exactly what `mf` assumes about the Hugo site it operates on. If you are adapting `mf` for your own site, this is the compatibility checklist. If the metafunctor.com site is ever rebuilt from scratch, this document tells you what structure to recreate.

The assumptions fall into three tiers: Hugo platform conventions, site directory structure, and theme-level contracts.

## Tier 1: Hugo Platform Conventions

These are standard Hugo behaviors. Any Hugo site already satisfies them.

| Assumption | Detail |
|------------|--------|
| Content lives in `content/` | All markdown content under `<site_root>/content/` |
| Static assets in `static/` | Files served verbatim under `<site_root>/static/` |
| YAML front matter | Delimited by `---` lines, parsed as YAML |
| Leaf bundles | `content/<section>/<slug>/index.md` |
| Branch bundles | `content/<section>/<slug>/_index.md` |
| Section `_index.md` | Top-level `_index.md` in each section directory is skipped during content scanning |
| Standard front matter fields | `title`, `date`, `draft`, `tags`, `categories`, `description`, `featured`, `aliases` |
| `hugo.toml` at site root | Used as fallback for `baseURL` resolution in series sync |

These are intentional and should not be abstracted away.

## Tier 2: Site Directory Structure

These are content section names and static asset paths. They are hardcoded in `mf` but could differ across Hugo sites.

### Content Sections

Defined in two places that must stay in sync:

**`SitePaths` dataclass** (`src/mf/core/config.py:23-53`):

| Field | Path | Used by |
|-------|------|---------|
| `papers` | `content/papers` | Paper generation, content scanner |
| `projects` | `content/projects` | Project generation, content scanner |
| `publications` | `content/publications` | Publication generation, content scanner |
| `posts` | `content/post` | Post management, content scanner, auditor |

Note: posts use the **singular** `content/post`, not `content/posts`. This is a metafunctor convention that would trip up many Hugo setups.

**`ContentScanner.CONTENT_TYPES`** (`src/mf/content/scanner.py:106-114`):

| Key | Path | Notes |
|-----|------|-------|
| `post` | `content/post` | Blog posts (singular) |
| `papers` | `content/papers` | All papers |
| `projects` | `content/projects` | GitHub projects |
| `writing` | `content/writing` | Long-form writing (not in SitePaths) |
| `publications` | `content/publications` | Peer-reviewed papers |
| `research` | `content/research` | Research content (not in SitePaths) |
| `series` | `content/series` | Blog series landing pages |

The scanner knows about `writing`, `research`, and `series` sections that SitePaths does not track. These are only scanned for read purposes (analytics, auditing), not generated into.

**`ContentAuditor.DEFAULT_CONTENT_TYPES`** (`src/mf/content/auditor.py:146`):

```python
DEFAULT_CONTENT_TYPES = ("post", "papers", "writing")
```

These are the sections audited by default for `linked_project` references. The `writing` section is metafunctor-specific.

### Static Asset Paths

| Path | Purpose | Source |
|------|---------|--------|
| `static/latex/<slug>/` | Compiled LaTeX HTML output per paper | `SitePaths.latex` |
| `static/latex/<slug>/index.html` | Main HTML rendering of paper | Embedded via iframe in paper pages |
| `static/latex/<slug>/<slug>.pdf` | PDF file for each paper | Referenced in paper front matter |

The `static/latex/` convention is central to how papers work. The paper page embeds `<iframe src="/latex/{slug}/index.html">` and links to `/latex/{slug}/{pdf_file}`.

## Tier 3: Theme Contract

These are front matter fields, taxonomies, and layouts that `mf` generates and that the Hugo theme must understand. This is the tightest coupling.

### Custom Taxonomies

| Taxonomy | Front matter key | Purpose | Used by |
|----------|-----------------|---------|---------|
| `linked_project` | `linked_project: [slug1, slug2]` | Links content to project pages | Content matcher, auditor, scanner |
| `series` | `series: [series-name]` | Groups posts into series | Series module |

Your Hugo theme must register these in `hugo.toml`:

```toml
[taxonomies]
  tag = "tags"
  category = "categories"
  linked_project = "linked_project"
  series = "series"
```

### Custom Layouts

| Layout | Set by | Purpose |
|--------|--------|---------|
| `project-landing` | `projects/generator.py:147` | Branch bundle root for rich projects |
| `project-section` | `projects/generator.py:300` | Sub-sections (docs, tutorials, etc.) within rich projects |

These layouts must exist in the theme's `layouts/` directory. Simple (leaf bundle) projects use the default `projects/single.html` layout.

### Paper Front Matter

Generated by `papers/templates.py`. Fields the theme should understand:

```yaml
# Standard Hugo
title: "Paper Title"
slug: "paper-slug"
date: 2024-01-15
draft: false
tags: [statistics, reliability]
featured: true

# Paper-specific
authors:
  - "Author Name"
abstract: "Paper abstract text"
category: "preprint"          # preprint, journal, conference, thesis
stars: 5                      # Quality rating (1-5)
venue: "Journal Name"
status: "published"           # draft, preprint, submitted, published
arxiv_id: "2401.12345"
doi: "10.1234/example"
github_url: "https://github.com/..."
project_url: "/projects/related-project/"
external_url: "https://..."
image: "thumbnail.png"

# PDF display
pdf_file: "paper.pdf"         # Filename only, served from /latex/{slug}/
pdf_size: "1.2 MB"
page_count: 15
pdf_only: false               # true = PDF embed, false = HTML iframe
```

Paper pages also include inline HTML/CSS/JS in the body for the iframe embed or PDF viewer. The CSS classes used are: `.iframe-wrap`, `.action-bar`, `.pdf-container`. These reference CSS custom properties from the theme:

- `--color-border-default` (fallback: `#ddd`)
- `--color-accent-primary` (fallback: `#007acc`)
- `--color-bg-secondary` (fallback: `#f5f5f5`)

### Publication Front Matter

Generated by `publications/generate.py`. Subset of papers that are peer-reviewed:

```yaml
title: "Paper Title"
abstract: "..."
authors:
  - name: "Author Name"       # Note: dict format, not plain string
date: "2024-01-15T00:00:00Z"
tags: [statistics]

publication:                   # Nested under publication:
  type: "journal"
  venue: "Journal Name"
  status: "published"
  doi: "10.1234/example"
  year: 2024

links:
  - name: "GitHub"
    url: "https://github.com/..."
  - name: "Paper"
    url: "/papers/paper-slug/"

# Asset paths (full paths, not filenames)
pdf: "/latex/slug/paper.pdf"
html: "/latex/slug/"
cite: "/latex/slug/cite.bib"
```

Key difference from papers: publications use full paths (`pdf: "/latex/slug/paper.pdf"`) while papers use filenames (`pdf_file: "paper.pdf"`). The theme must handle both patterns.

### Project Front Matter

Generated by `projects/generator.py`. The most complex front matter structure:

```yaml
# Standard Hugo
title: "Project Name"
date: 2024-01-15T00:00:00Z
draft: false
description: "One-line description"
featured: false
categories: []
aliases: []                    # Hugo URL redirects

# Nested project metadata
project:
  status: "active"
  type: "library"              # library, tool, application, research, etc.
  year_started: 2024

tech:
  languages:
    - "Python"
  frameworks: []
  topics: ["statistics", "reliability"]

sources:
  github: "https://github.com/user/repo"
  github_pages: "https://user.github.io/repo"
  documentation: ""

packages:
  pypi: "package-name"
  npm: ""
  cran: ""
  r_universe: ""
  crates: ""
  conan: ""
  vcpkg: ""

external_docs:
  readthedocs: "https://..."

papers:
  - title: "Related Paper"
    venue: "Conference"
    year: 2024
    arxiv: "2401.12345"
    doi: "10.1234/..."
    pdf: "/latex/slug/paper.pdf"

metrics:
  stars: 42                    # GitHub stars
  downloads: 0
  citations: 0

image: "screenshot.png"

related_posts:
  - "/post/2024-01-about-project/"
related_projects:
  - "/projects/related-project/"
```

The theme must render all nested sections (`project`, `tech`, `sources`, `packages`, `metrics`, `papers`, `external_docs`). This is the deepest coupling point.

### Branch Bundle Sections for Rich Projects

Rich projects (branch bundles) create sub-directories with `_index.md` files:

| Section | Weight | Default title |
|---------|--------|---------------|
| `docs` | 10 | Documentation |
| `tutorials` | 20 | Tutorials |
| `posts` | 25 | Posts |
| `examples` | 30 | Examples |
| `api` | 40 | API Reference |
| `changelog` | 50 | Changelog |

Each section page uses `layout: project-section`.

### Post Front Matter

Posts are managed via `mf posts` (database-free, reads/writes front matter directly). The `set`/`unset`/`feature`/`tag` commands manipulate standard Hugo fields plus:

- `linked_project: [slug]` - Custom taxonomy
- `series: [name]` - Custom taxonomy
- `related_posts: ["/post/..."]`
- `related_projects: ["/projects/..."]`

## Hardcoded GitHub Username

Several files contain the hardcoded GitHub username `queelius`:

| File | Line | Context |
|------|------|---------|
| `content/scanner.py:364` | `f"github.com/queelius/{project_slug}"` | Finding content about a project |
| `content/matcher.py:114,125` | `f"github.com/queelius/{slug}"` | Matching content to projects |
| `analytics/aggregator.py:315,516` | `f"github.com/queelius/{slug}"` | Analytics link suggestions |

These construct GitHub URLs for content matching. If a different user operates `mf`, these would need updating. The username should ideally come from configuration or be inferred from the projects database.

## Hardcoded Fallback URL

`series/mkdocs.py:84` has a hardcoded fallback:

```python
return "https://metafunctor.com/"
```

This is used when neither `.mf/config.yaml` `site_url` nor `hugo.toml` `baseURL` provides a URL. It should use a generic fallback or error instead.

## What You Need to Reproduce This Site

If rebuilding metafunctor.com or adapting `mf` for a new site:

1. **Hugo site with `hugo.toml`** at root
2. **`.mf/` directory** at site root (created by `mf init`)
3. **Content sections**: `content/post/`, `content/papers/`, `content/projects/`, `content/publications/`, `content/series/` (and optionally `content/writing/`, `content/research/`)
4. **Static directory**: `static/latex/` for compiled paper assets
5. **Custom taxonomies**: `linked_project` and `series` registered in `hugo.toml`
6. **Custom layouts**: `project-landing` and `project-section` in the theme
7. **Theme support** for the nested front matter structures described above
8. **CSS custom properties**: `--color-border-default`, `--color-accent-primary`, `--color-bg-secondary` (or accept the fallback values)

## Future Configurability

The most impactful changes for making `mf` portable:

1. **Content section name map** — Move `CONTENT_TYPES` from class variable to config. The `post` vs `posts` difference alone blocks adoption.
2. **GitHub username** — Read from config or infer from project data instead of hardcoding `queelius`.
3. **Fallback URL** — Remove the `metafunctor.com` default; require explicit configuration.
4. **Front matter schema** — The nested project structure (`project:`, `tech:`, `sources:`, `packages:`, `metrics:`) is the hardest to generalize. Consider flattening or making the nesting configurable per theme.

These are documented for future work. The current priority is making the coupling explicit, not eliminating it.
